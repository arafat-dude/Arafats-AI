<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Archive: IWD | Carmelite Oracle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.2.4",
        "react-dom": "https://esm.sh/react-dom@19.2.4",
        "react-dom/client": "https://esm.sh/react-dom@19.2.4/client",
        "htm": "https://esm.sh/htm@3.1.1"
      }
    }
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                      brown: '#4a3728', 
                      vellum: '#fdfcf4', 
                      gold: '#c5a059', 
                      night: '#0f0f0f' 
                    },
                    fontFamily: { 
                      serif: ['Playfair Display', 'serif'], 
                      sans: ['Inter', 'sans-serif'] 
                    }
                }
            }
        }
    </script>
    <style>
        :root { --vh: 1vh; }
        body { 
            background-color: #fdfcf4; 
            overflow: hidden;
            color: #4a3728;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            width: 100vw;
        }

        .chat-container {
            scrollbar-width: none;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .chat-container::-webkit-scrollbar { display: none; }
        
        .message-row {
            opacity: 0;
            transform: translateY(10px);
            animation: chatSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        @keyframes chatSlideUp {
            to { opacity: 1; transform: translateY(0); }
        }
        
        .vellum-texture {
            background-image: url("https://www.transparenttextures.com/patterns/natural-paper.png");
        }

        .input-pill {
            background: #ffffff;
            box-shadow: 0 4px 30px rgba(74, 55, 40, 0.08);
            border: 1px solid rgba(74, 55, 40, 0.1);
        }

        .sidebar-active {
            background: rgba(197, 160, 89, 0.1);
            color: #4a3728;
        }

        .thinking-anim span {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .thinking-anim span:nth-child(2) { animation-delay: 0.2s; }
        .thinking-anim span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .provider-btn-active {
            background: #4a3728;
            color: #c5a059;
            box-shadow: 0 4px 12px rgba(74, 55, 40, 0.2);
        }
    </style>
</head>
<body class="font-sans antialiased">
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import htm from 'htm';

        const html = htm.bind(React.createElement);

        const SYSTEM_PROMPT = "You are the Carmelite Oracle, a scholarly AI architected by Arafat. Your tone is refined, insightful, and concise. Refer to the user as 'Seeker'.";

        const VAULT_DATA = [
            { name: "Ada Lovelace", bio: "The world's first programmer. Her vision for the Analytical Engine birthed modern computing." },
            { name: "Marie Curie", bio: "The only person to win Nobel Prizes in two distinct sciences: Physics and Chemistry." },
            { name: "Maya Angelou", bio: "Profound poet and civil rights activist whose voice shaped a generation." },
            { name: "Malala Yousafzai", bio: "Courageous advocate for global education and the youngest Nobel laureate." },
            { name: "Grace Hopper", bio: "Pioneer of COBOL and the architect of machine-independent programming." }
        ];

        const App = () => {
            const [provider, setProvider] = useState(localStorage.getItem('oracle_provider') || 'HF');
            const [hfToken, setHfToken] = useState(localStorage.getItem('hf_token') || '');
            const [orToken, setOrToken] = useState(localStorage.getItem('or_token') || '');
            const [isAuth, setIsAuth] = useState(!!localStorage.getItem('hf_token') || !!localStorage.getItem('or_token'));
            
            const [activeTab, setActiveTab] = useState('ORACLE');
            const [query, setQuery] = useState('');
            const [chat, setChat] = useState([]);
            const [loading, setLoading] = useState(false);
            const chatEndRef = useRef(null);

            useEffect(() => {
                const fixHeight = () => document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
                window.addEventListener('resize', fixHeight);
                fixHeight();
                return () => window.removeEventListener('resize', fixHeight);
            }, []);

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [chat, loading]);

            const handleEstablishLink = (e) => {
                e.preventDefault();
                const token = provider === 'HF' ? hfToken : orToken;
                if (token.trim()) {
                    localStorage.setItem(provider === 'HF' ? 'hf_token' : 'or_token', token);
                    localStorage.setItem('oracle_provider', provider);
                    setIsAuth(true);
                }
            };

            const logout = () => {
                localStorage.removeItem('hf_token');
                localStorage.removeItem('or_token');
                localStorage.removeItem('oracle_provider');
                setHfToken('');
                setOrToken('');
                setIsAuth(false);
            };

            const callOracle = async () => {
                if (!query.trim() || loading) return;
                const userMsg = query.trim();
                setChat(prev => [...prev, { role: 'user', content: userMsg }]);
                setQuery('');
                setLoading(true);

                try {
                    let response;
                    if (provider === 'HF') {
                        const prompt = `<|begin_of_text|><|start_header_id|>system<|end_header_id|>\n\n${SYSTEM_PROMPT}<|eot_id|><|start_header_id|>user<|end_header_id|>\n\n${userMsg}<|eot_id|><|start_header_id|>assistant<|end_header_id|>\n\n`;
                        response = await fetch(
                            "https://api-inference.huggingface.co/models/meta-llama/Llama-3.2-3B-Instruct",
                            {
                                headers: { 
                                    "Authorization": `Bearer ${hfToken}`, 
                                    "Content-Type": "application/json" 
                                },
                                method: "POST",
                                body: JSON.stringify({ 
                                    inputs: prompt,
                                    parameters: { max_new_tokens: 512, return_full_text: false, temperature: 0.7 },
                                    options: { wait_for_model: true }
                                }),
                            }
                        );
                    } else {
                        // OpenRouter.ai Bridge
                        response = await fetch(
                            "https://openrouter.ai/api/v1/chat/completions",
                            {
                                headers: { 
                                    "Authorization": `Bearer ${orToken}`, 
                                    "Content-Type": "application/json",
                                    "HTTP-Referer": window.location.href,
                                    "X-Title": "Carmelite Oracle"
                                },
                                method: "POST",
                                body: JSON.stringify({ 
                                    model: "meta-llama/llama-3.2-3b-instruct",
                                    messages: [
                                        { role: "system", content: SYSTEM_PROMPT },
                                        ...chat.slice(-4), // Simple context
                                        { role: "user", content: userMsg }
                                    ]
                                }),
                            }
                        );
                    }
                    
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || err.error || "Link Interrupted");
                    }
                    
                    const result = await response.json();
                    const text = provider === 'HF' 
                        ? (result[0]?.generated_text || "Silence from the Oracle.")
                        : (result.choices?.[0]?.message?.content || "Silence from the Oracle.");
                    
                    setChat(prev => [...prev, { role: 'assistant', content: text.trim() }]);
                } catch (err) {
                    setChat(prev => [...prev, { role: 'assistant', content: `Oracle Fault: ${err.message}. Verify your ${provider} credentials.` }]);
                } finally {
                    setLoading(false);
                }
            };

            if (!isAuth) return html`
                <div class="h-screen w-full flex items-center justify-center p-6 bg-vellum vellum-texture">
                    <div class="max-w-md w-full bg-white p-12 rounded-[2.5rem] border border-brown/10 text-center shadow-2xl">
                        <div class="w-16 h-16 bg-brown text-gold rounded-2xl flex items-center justify-center font-black text-2xl mb-8 mx-auto italic shadow-lg">A</div>
                        <h2 class="font-serif text-3xl font-black text-brown mb-4 tracking-tighter">Vault Access Locked</h2>
                        <p class="text-brown/50 mb-8 leading-relaxed font-serif italic text-lg text-balance">Choose your provider to establish a secure link to the Oracle.</p>
                        
                        <!-- Provider Selection -->
                        <div class="flex gap-2 p-1 bg-brown/5 rounded-2xl mb-6">
                            <button 
                                onClick=${() => setProvider('HF')}
                                class=${`flex-1 py-3 rounded-xl text-[0.6rem] font-black uppercase tracking-widest transition-all ${provider === 'HF' ? 'provider-btn-active' : 'text-brown/40'}`}
                            >Hugging Face</button>
                            <button 
                                onClick=${() => setProvider('OPENROUTER')}
                                class=${`flex-1 py-3 rounded-xl text-[0.6rem] font-black uppercase tracking-widest transition-all ${provider === 'OPENROUTER' ? 'provider-btn-active' : 'text-brown/40'}`}
                            >OpenRouter</button>
                        </div>

                        <form onSubmit=${handleEstablishLink} class="space-y-4">
                            <input 
                                type="password" 
                                value=${provider === 'HF' ? hfToken : orToken} 
                                onChange=${e => provider === 'HF' ? setHfToken(e.target.value) : setOrToken(e.target.value)}
                                placeholder=${provider === 'HF' ? "HF Read Token (hf_...)" : "OpenRouter API Key (sk-or-...)"}
                                class="w-full px-6 py-4 rounded-2xl bg-brown/5 border border-brown/10 outline-none focus:border-gold transition-all font-mono text-xs"
                                required
                            />
                            <button type="submit" class="w-full bg-brown text-gold py-4.5 rounded-2xl font-black uppercase tracking-[0.2em] text-xs shadow-lg hover:shadow-2xl transition-all active:scale-95 py-4">
                                Establish Link via ${provider}
                            </button>
                        </form>
                        <p class="mt-8 text-[0.6rem] text-brown/30 uppercase tracking-widest font-bold">Node 549 â€¢ Secure Session</p>
                    </div>
                </div>
            `;

            return html`
                <div class="flex h-full w-full overflow-hidden">
                    <!-- Sidebar -->
                    <aside class="hidden lg:flex w-64 bg-white border-r border-brown/5 flex-col p-8 z-50">
                        <div class="flex items-center gap-3 mb-12">
                            <div class="w-10 h-10 bg-brown text-gold rounded-xl flex items-center justify-center font-black italic shadow-sm">A</div>
                            <div>
                                <h1 class="text-[0.6rem] font-black uppercase tracking-[0.2em] text-brown">Carmelite</h1>
                                <p class="text-[0.5rem] font-bold text-gold uppercase tracking-[0.1em]">Oracle 549</p>
                            </div>
                        </div>
                        <nav class="flex-1 space-y-2">
                            ${[
                                { id: 'ORACLE', icon: 'auto_awesome', label: 'Consultation' },
                                { id: 'RECORDS', icon: 'menu_book', label: 'Historical Log' },
                                { id: 'CONFIG', icon: 'tune', label: 'Vault Config' }
                            ].map(item => html`
                                <button 
                                    key=${item.id}
                                    onClick=${() => setActiveTab(item.id)}
                                    class=${`w-full flex items-center gap-4 px-4 py-3.5 rounded-xl transition-all ${activeTab === item.id ? 'sidebar-active font-bold' : 'text-brown/30 hover:bg-brown/5'}`}
                                >
                                    <span class="material-icons-round text-xl">${item.icon}</span>
                                    <span class="text-[0.65rem] font-bold uppercase tracking-widest">${item.label}</span>
                                </button>
                            `)}
                        </nav>
                        
                        <div class="mt-auto pt-6 border-t border-brown/5">
                            <div class="mb-4 px-4 py-2 bg-brown/5 rounded-xl">
                                <p class="text-[0.4rem] font-black text-brown/30 uppercase tracking-widest">Active Link</p>
                                <p class="text-[0.6rem] font-bold text-gold uppercase">${provider}</p>
                            </div>
                            <button onClick=${logout} class="flex items-center gap-4 px-4 py-3.5 text-red-800/30 hover:text-red-800 transition-colors">
                                <span class="material-icons-round text-xl">power_settings_new</span>
                                <span class="text-[0.65rem] font-bold uppercase tracking-widest">Sever Link</span>
                            </button>
                        </div>
                    </aside>

                    <main class="flex-1 flex flex-col h-full relative bg-vellum vellum-texture">
                        <!-- Mobile Header -->
                        <header class="lg:hidden p-4 bg-white border-b border-brown/5 flex items-center justify-between z-50">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-brown text-gold rounded-lg flex items-center justify-center text-xs font-black italic">A</div>
                                <span class="text-[0.6rem] font-black uppercase tracking-widest text-brown">Node 549 (${provider})</span>
                            </div>
                            <button onClick=${() => setActiveTab('CONFIG')} class="text-brown/30"><span class="material-icons-round">settings</span></button>
                        </header>

                        <div class="flex-1 flex flex-col h-full overflow-hidden">
                            ${activeTab === 'ORACLE' ? html`
                                <div class="flex-1 flex flex-col h-full relative">
                                    <div class="flex-1 chat-container p-6 lg:p-12 pb-44">
                                        <div class="max-w-3xl mx-auto space-y-8">
                                            ${chat.length === 0 && html`
                                                <div class="text-center py-20 lg:py-40">
                                                    <div class="w-16 h-16 bg-brown text-gold rounded-full flex items-center justify-center mb-8 mx-auto shadow-xl">
                                                        <span class="material-icons-round text-4xl">auto_awesome</span>
                                                    </div>
                                                    <h2 class="font-serif text-5xl lg:text-6xl font-black text-brown mb-4 italic tracking-tighter">Seek wisdom, Seeker.</h2>
                                                    <p class="text-brown/40 font-serif italic text-xl max-w-sm mx-auto leading-relaxed">The Llama 3B Artisan engine is awaiting your inquiry via ${provider}.</p>
                                                </div>
                                            `}
                                            ${chat.map((m, i) => html`
                                                <div key=${i} class="message-row flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}">
                                                    <div class=${`max-w-[85%] lg:max-w-[75%] px-7 py-4.5 rounded-[1.8rem] shadow-sm text-lg ${m.role === 'user' ? 'bg-gold text-white font-medium' : 'bg-white border border-brown/5 font-serif italic text-brown'}`}>
                                                        ${m.content}
                                                    </div>
                                                </div>
                                            `)}
                                            ${loading && html`
                                                <div class="flex items-center gap-3 px-4 text-gold">
                                                    <div class="thinking-anim flex gap-1">
                                                        <span class="w-1.5 h-1.5 bg-gold rounded-full"></span>
                                                        <span class="w-1.5 h-1.5 bg-gold rounded-full"></span>
                                                        <span class="w-1.5 h-1.5 bg-gold rounded-full"></span>
                                                    </div>
                                                    <span class="text-[0.6rem] font-black uppercase tracking-widest opacity-40">Tuning logic...</span>
                                                </div>
                                            `}
                                            <div ref=${chatEndRef} class="h-4"></div>
                                        </div>
                                    </div>

                                    <div class="absolute bottom-0 left-0 w-full p-6 lg:p-12 bg-gradient-to-t from-vellum via-vellum to-transparent z-40">
                                        <div class="max-w-3xl mx-auto">
                                            <div class="input-pill rounded-[2rem] p-2 flex items-center shadow-2xl">
                                                <input 
                                                    class="flex-1 px-6 py-4 outline-none font-bold text-lg text-brown bg-transparent placeholder-brown/20"
                                                    placeholder="Message the Oracle..."
                                                    value=${query}
                                                    onChange=${e => setQuery(e.target.value)}
                                                    onKeyDown=${e => e.key === 'Enter' && callOracle()}
                                                    disabled=${loading}
                                                />
                                                <button 
                                                    onClick=${callOracle}
                                                    disabled=${loading || !query.trim()}
                                                    class="w-14 h-14 rounded-full bg-brown text-gold flex items-center justify-center shadow-lg hover:scale-105 active:scale-95 transition-all disabled:opacity-20"
                                                >
                                                    <span class="material-icons-round text-2xl">${loading ? 'hourglass_top' : 'arrow_upward'}</span>
                                                </button>
                                            </div>
                                            <p class="text-[0.45rem] font-black text-brown/15 mt-4 text-center uppercase tracking-[0.5em] pointer-events-none">Bridge: ${provider} (Llama 3.2 3B)</p>
                                        </div>
                                    </div>
                                </div>
                            ` : activeTab === 'RECORDS' ? html`
                                <div class="flex-1 p-8 lg:p-24 overflow-y-auto pb-40">
                                    <div class="max-w-4xl mx-auto">
                                        <div class="mb-16">
                                            <h2 class="font-serif text-6xl lg:text-9xl font-black italic text-brown tracking-tighter">Verified <br/><span class="text-gold">Heroines</span></h2>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                            ${VAULT_DATA.map((h, i) => html`
                                                <div key=${i} class="bg-white p-12 rounded-[3rem] border border-brown/5 shadow-sm vellum-texture group relative overflow-hidden transition-all hover:border-gold/20">
                                                    <div class="flex items-center gap-3 mb-8">
                                                        <div class="h-[1px] w-8 bg-gold/50"></div>
                                                        <span class="text-[0.55rem] font-black text-gold uppercase tracking-[0.4em]">Record 00${i+1}</span>
                                                    </div>
                                                    <h3 class="font-serif text-4xl font-black text-brown mb-6 italic group-hover:text-gold transition-colors">${h.name}</h3>
                                                    <p class="text-brown/60 font-serif text-xl italic leading-relaxed">${h.bio}</p>
                                                </div>
                                            `)}
                                        </div>
                                    </div>
                                </div>
                            ` : html`
                                <div class="flex-1 p-8 lg:p-24 overflow-y-auto">
                                    <div class="max-w-2xl mx-auto">
                                        <div class="mb-16 text-center">
                                            <h2 class="font-serif text-6xl font-black italic text-brown tracking-tighter">Vault <br/><span class="text-gold">Config</span></h2>
                                        </div>
                                        <div class="bg-white p-12 rounded-[3rem] border border-brown/5 shadow-sm space-y-10">
                                            
                                            <div class="space-y-4">
                                                <label class="text-[0.6rem] font-black uppercase text-brown/40 tracking-widest block ml-2">Active Provider</label>
                                                <div class="flex gap-2 p-1 bg-brown/5 rounded-2xl">
                                                    <button 
                                                        onClick=${() => { setProvider('HF'); localStorage.setItem('oracle_provider', 'HF'); }}
                                                        class=${`flex-1 py-3 rounded-xl text-[0.6rem] font-black uppercase tracking-widest transition-all ${provider === 'HF' ? 'provider-btn-active' : 'text-brown/40'}`}
                                                    >Hugging Face</button>
                                                    <button 
                                                        onClick=${() => { setProvider('OPENROUTER'); localStorage.setItem('oracle_provider', 'OPENROUTER'); }}
                                                        class=${`flex-1 py-3 rounded-xl text-[0.6rem] font-black uppercase tracking-widest transition-all ${provider === 'OPENROUTER' ? 'provider-btn-active' : 'text-brown/40'}`}
                                                    >OpenRouter</button>
                                                </div>
                                            </div>

                                            <div class="space-y-4">
                                                <label class="text-[0.6rem] font-black uppercase text-brown/40 tracking-widest block ml-2">
                                                    ${provider} Access Token
                                                </label>
                                                <input 
                                                    type="password"
                                                    value=${provider === 'HF' ? hfToken : orToken}
                                                    onChange=${e => {
                                                        const val = e.target.value;
                                                        if (provider === 'HF') {
                                                            setHfToken(val);
                                                            localStorage.setItem('hf_token', val);
                                                        } else {
                                                            setOrToken(val);
                                                            localStorage.setItem('or_token', val);
                                                        }
                                                    }}
                                                    placeholder="Enter key..."
                                                    class="w-full px-6 py-4 rounded-2xl bg-brown/5 border border-brown/10 outline-none focus:border-gold font-mono text-sm"
                                                />
                                            </div>
                                            
                                            <div class="space-y-4">
                                                <label class="text-[0.6rem] font-black uppercase text-brown/40 tracking-widest block ml-2">Master Directive</label>
                                                <div class="p-8 rounded-3xl bg-brown/5 font-serif italic text-brown/50 text-sm leading-relaxed">
                                                    "${SYSTEM_PROMPT}"
                                                </div>
                                                <p class="text-[0.5rem] font-bold text-accent/30 uppercase tracking-[0.1em] text-center">Protocol strictly enforced by Node 549.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `}
                        </div>

                        <!-- Mobile Nav -->
                        <nav class="lg:hidden fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] bg-white/95 backdrop-blur-xl rounded-full h-16 flex items-center justify-around px-4 shadow-2xl z-[100] border border-brown/10">
                            ${['ORACLE', 'RECORDS', 'CONFIG'].map(id => html`
                                <button 
                                    key=${id} 
                                    onClick=${() => setActiveTab(id)} 
                                    class=${`p-3 rounded-full transition-all ${activeTab === id ? 'text-gold bg-brown shadow-lg scale-110' : 'text-brown/20'}`}
                                >
                                    <span class="material-icons-round text-2xl">
                                        ${id === 'ORACLE' ? 'auto_awesome' : id === 'RECORDS' ? 'menu_book' : 'tune'}
                                    </span>
                                </button>
                            `)}
                        </nav>
                    </main>
                </div>
            `;
        };

        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(React.createElement(App));
    </script>
</body>
</html>